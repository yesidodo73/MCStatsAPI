<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>mcstats Analytics Dashboard</title>
  <style>
    :root {
      --bg: #f6f1e8;
      --panel: #fffdf8;
      --ink: #1f2d2a;
      --muted: #556b66;
      --accent: #1b7a5b;
      --danger: #a33535;
      --line: #d8d0c1;
      --card-shadow: 0 10px 30px rgba(23, 29, 27, 0.08);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--ink);
      background:
        radial-gradient(circle at 10% -20%, rgba(27,122,91,0.2), transparent 30%),
        radial-gradient(circle at 100% 0, rgba(255,167,38,0.16), transparent 25%),
        var(--bg);
      font-family: "Segoe UI", "Noto Sans", sans-serif;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 20px 40px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
      margin-bottom: 20px;
    }

    .title {
      font-size: clamp(24px, 3.5vw, 44px);
      font-weight: 800;
      letter-spacing: -0.03em;
      margin: 0;
    }

    .subtitle {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    select, button {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: var(--panel);
      color: var(--ink);
    }

    button {
      cursor: pointer;
      background: var(--accent);
      border-color: var(--accent);
      color: #f1fff8;
      font-weight: 600;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 14px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--card-shadow);
      padding: 14px;
    }

    .kpi { grid-column: span 4; }
    .trend { grid-column: span 12; }
    .hourly { grid-column: span 12; }

    @media (max-width: 900px) {
      .kpi { grid-column: span 12; }
    }

    .kpi-label {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 800;
      line-height: 1.2;
    }

    .trend-pill {
      margin-top: 8px;
      font-size: 13px;
      font-weight: 700;
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: #eef6f3;
      color: var(--accent);
    }

    .trend-pill.down {
      background: #fbeeee;
      color: var(--danger);
    }

    .section-title {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 700;
    }

    .chart-wrap {
      width: 100%;
      overflow-x: auto;
    }

    svg { display: block; width: 100%; height: auto; }

    .legend {
      display: flex;
      gap: 12px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 99px;
      display: inline-block;
      margin-right: 6px;
    }

    .dot.active { background: #1b7a5b; }
    .dot.new { background: #ef8f00; }
    .bar-grid {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 4px;
      align-items: end;
      min-height: 170px;
      margin-top: 6px;
    }

    .bar {
      background: linear-gradient(180deg, #2a8f6d 0%, #1b7a5b 100%);
      border-radius: 4px 4px 0 0;
      min-height: 2px;
    }

    .hour-labels {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 class="title">MCStats Pro Analytics</h1>
        <p class="subtitle" id="windowLabel">Loading...</p>
      </div>
      <div class="controls">
        <label for="days">Range</label>
        <select id="days">
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
        <button id="refreshBtn" type="button">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <section class="card kpi">
        <div class="kpi-label">New Players</div>
        <div class="kpi-value" id="newPlayers">-</div>
        <span class="trend-pill" id="newTrend">-</span>
      </section>

      <section class="card kpi">
        <div class="kpi-label">Active Players</div>
        <div class="kpi-value" id="activePlayers">-</div>
        <span class="trend-pill" id="activeTrend">-</span>
      </section>

      <section class="card kpi">
        <div class="kpi-label">Average Daily Active Players</div>
        <div class="kpi-value" id="avgPlayers">-</div>
        <span class="trend-pill" id="avgTrend">-</span>
      </section>

      <section class="card trend">
        <h2 class="section-title">Daily Trend</h2>
        <div class="legend">
          <span><span class="dot active"></span>Active Players</span>
          <span><span class="dot new"></span>New Players</span>
        </div>
        <div class="chart-wrap">
          <svg id="trendChart" viewBox="0 0 1000 280" preserveAspectRatio="none"></svg>
        </div>
      </section>

      <section class="card hourly">
        <h2 class="section-title">Hourly Average Players (Local Time)</h2>
        <div class="bar-grid" id="hourlyBars"></div>
        <div class="hour-labels">
          <span>00:00</span><span>03:00</span><span>06:00</span><span>09:00</span>
          <span>12:00</span><span>15:00</span><span>18:00</span><span>21:00</span>
        </div>
      </section>
    </div>
  </div>

  <script>
    const daysSelect = document.getElementById("days");
    const refreshBtn = document.getElementById("refreshBtn");
    const windowLabel = document.getElementById("windowLabel");

    const fmt = new Intl.NumberFormat();

    function setTrend(el, trend) {
      const sign = trend.delta > 0 ? "+" : "";
      el.textContent = `${sign}${trend.delta} (${sign}${trend.changePercent}%)`;
      if (trend.direction === "down") {
        el.classList.add("down");
      } else {
        el.classList.remove("down");
      }
    }

    function drawTrend(svg, points) {
      svg.innerHTML = "";
      const w = 1000;
      const h = 280;
      const pad = 28;
      if (!points.length) {
        return;
      }

      const maxValue = Math.max(
        1,
        ...points.map(p => p.activePlayers),
        ...points.map(p => p.newPlayers)
      );

      const x = i => pad + (i * (w - pad * 2) / Math.max(1, points.length - 1));
      const y = v => h - pad - ((v / maxValue) * (h - pad * 2));

      for (let i = 0; i < 5; i++) {
        const yy = pad + (i * (h - pad * 2) / 4);
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", String(pad));
        line.setAttribute("x2", String(w - pad));
        line.setAttribute("y1", String(yy));
        line.setAttribute("y2", String(yy));
        line.setAttribute("stroke", "#ece5d8");
        line.setAttribute("stroke-width", "1");
        svg.appendChild(line);
      }

      const makePath = (selector, color) => {
        const d = points.map((p, i) => `${i === 0 ? "M" : "L"} ${x(i)} ${y(p[selector])}`).join(" ");
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", d);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", color);
        path.setAttribute("stroke-width", "3");
        path.setAttribute("stroke-linecap", "round");
        path.setAttribute("stroke-linejoin", "round");
        svg.appendChild(path);
      };

      makePath("activePlayers", "#1b7a5b");
      makePath("newPlayers", "#ef8f00");
    }

    function drawHourlyBars(hourly) {
      const wrap = document.getElementById("hourlyBars");
      wrap.innerHTML = "";
      const byHour = new Array(24).fill(0);
      for (const item of hourly) {
        byHour[item.hour] = item.averagePlayers;
      }
      const max = Math.max(1, ...byHour);
      byHour.forEach(v => {
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.height = `${Math.max(2, (v / max) * 160)}px`;
        bar.title = `${v.toFixed(2)} players`;
        wrap.appendChild(bar);
      });
    }

    async function load() {
      const days = Number(daysSelect.value);
      const [overviewRes, dailyRes] = await Promise.all([
        fetch(`/v1/analytics/overview?days=${days}`),
        fetch(`/v1/analytics/daily?days=${days}`)
      ]);
      if (!overviewRes.ok || !dailyRes.ok) {
        throw new Error("Failed to load analytics.");
      }

      const overview = await overviewRes.json();
      const daily = await dailyRes.json();

      windowLabel.textContent = `${overview.windowStartDate} - ${overview.windowEndDate}`;
      document.getElementById("newPlayers").textContent = fmt.format(overview.newPlayers);
      document.getElementById("activePlayers").textContent = fmt.format(overview.activePlayers);
      document.getElementById("avgPlayers").textContent = overview.averageDailyActivePlayers.toFixed(2);

      setTrend(document.getElementById("newTrend"), overview.newPlayersTrend);
      setTrend(document.getElementById("activeTrend"), overview.activePlayersTrend);
      setTrend(document.getElementById("avgTrend"), overview.averageDailyActivePlayersTrend);

      drawTrend(document.getElementById("trendChart"), daily.points);
      drawHourlyBars(overview.hourlyAveragePlayers);
    }

    refreshBtn.addEventListener("click", () => { load().catch(console.error); });
    daysSelect.addEventListener("change", () => { load().catch(console.error); });
    load().catch(console.error);
  </script>
</body>
</html>
